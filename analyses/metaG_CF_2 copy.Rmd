---
title: "metaG_CF_2_copy"
author: "CF"
date: "4/8/2022"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
#use to set global options for chunks e.g., echo and warning options will be applied to all chunks:
knitr::opts_chunk$set(echo = TRUE)

# Clear environment:
rm(list=ls())

# Set working directory:
setwd("~/GitHub/WetlandMesocosm_GHG_Timberlake/analyses")

# Standard error (se) and confidence interval (ci):
se <- function(x, ...){sd(x, na.rm = TRUE)/sqrt(length(na.omit(x)))}
ci <- function(x, ...){1.96 * sd(x,na.rm = TRUE)}

# Code dependencies:
#source("../bin/DiversityFunctions.R")
#source("../bin/MothurTools.R")
require("vegan"); require("reshape"); require("ggplot2"): require("tidyr"); require("dplyr"); require("dbstats"); require("reshape2")
```

Import KO function files from JGI IMG/MER
```{r Import Files, include=FALSE}
#Create vector with desired row order:
sample_order <- c("03NFC", "03PFC", "03Pre", "06NFC", "06PFC", "06Pre", "08NFC", "08PFC", "08Pre", "09NFC", "09PFC", "09Pre", "10NFC", "10PFC", "10Pre", "11NFC", "11PFC", "11Pre", "12NFC", "12PFC", "12Pre", "16NFC", "16PFC", "16Pre")
length(sample_order) #Should be 24

#Denitrification KEGG module:
denit <- read.csv("~/GitHub/WetlandMesocosm_GHG_Timberlake/data/metaG/Redownloaded/CSV/Denit_CF.csv")
#Reorder rows:
denit <- denit[match(sample_order, denit$Sample), ]

#Methanogen Signature KEGG module:
meth <- read.csv("~/GitHub/WetlandMesocosm_GHG_Timberlake/data/metaG/Redownloaded/CSV/Meth_CF.csv")
meth <- meth[match(sample_order, meth$Sample), ]

#All Central Carbohydrate Metabolism KEGG modules:
carb_metab <- read.csv("~/GitHub/WetlandMesocosm_GHG_Timberlake/data/metaG/Redownloaded/CSV/Central_carb_metab_CF.csv")
carb_metab <- carb_metab[match(sample_order, carb_metab$Sample), ]

#Cytochrome C Oxidase KEGG module:
cytoCox <- read.csv("~/GitHub/WetlandMesocosm_GHG_Timberlake/data/metaG/Redownloaded/CSV/CytCOx_CF.csv")
cytoCox <- cytoCox[match(sample_order, cytoCox$Sample), ]

#Design file:
design <- read.csv("~/GitHub/WetlandMesocosm_GHG_Timberlake/data/metaG/design.csv")
design2 <- read.csv("~/GitHub/WetlandMesocosm_GHG_Timberlake/data/tmg_design.csv")
#Reorder rows of design:
design <- design[match(sample_order, design$Sample), ]

#Remove mock, field, and box samples from design2. 
rownames(design2) <- design2$sample
design2 <- design2[!(rownames(design2) %in% "MOCK"),]
design2 <- design2[!(rownames(design2) %in% "TL1"),]
design2 <- design2[!(rownames(design2) %in% "TL2"),]
design2 <- design2[!(rownames(design2) %in% "TL3"),]
design2 <- design2[!(rownames(design2) %in% "TL4"),]
design2 <- design2[!(rownames(design2) %in% "TL5"),]
design2 <- design2[!(rownames(design2) %in% "TL6"),]
design2 <- design2[!(design2$source %in% "b"),]
design2 <- design2[!(design2$source %in% "s"),]

#Greenhouse gas data:
GHG <- read.csv("~/GitHub/WetlandMesocosm_GHG_Timberlake/data/TMG_GHG-Flux_T1_Pub_2-2020.csv")

```

Convert gene counts to relative abundance:
```{r}
#Make sample IDs the rownames:
denitNumerical <- denit
rownames(denitNumerical) <- denitNumerical$Sample

methNumerical <- meth
rownames(methNumerical) <- methNumerical$Sample

carb_metabNumerical <- carb_metab
rownames(carb_metabNumerical) <- carb_metabNumerical$Sample

cytoCoxNumerical <- cytoCox
rownames(cytoCoxNumerical) <- cytoCoxNumerical$Sample

# Drop all non-numeric variables:
denitNumerical <- denitNumerical[,3:12]
methNumerical <- methNumerical[,3:46]
carb_metabNumerical <- carb_metabNumerical[,3:122]
cytoCoxNumerical <- cytoCoxNumerical[,3:7]

#Convert denitrification KO counts to relative abundance:
denitRA <- denitNumerical
for(i in 1:dim(denitNumerical)[1]){
  denitRA[i,] <- denitNumerical[i,]/sum(denitNumerical[i,])
}

#Convert methanogen KO counts to relative abundance:
methRA <- methNumerical
for(i in 1:dim(methNumerical)[1]){
  methRA[i,] <- methNumerical[i,]/sum(methNumerical[i,])
}

#Convert central carbohydrate metabolism KO counts to relative abundance:
carb_metabRA <- carb_metabNumerical
for(i in 1:dim(carb_metabNumerical)[1]){
  carb_metabRA[i,] <- carb_metabNumerical[i,]/sum(carb_metabNumerical[i,])
}

#Convert cytochrome c oxidase KO counts to relative abundance:
cytoCoxRA <- cytoCoxNumerical
for(i in 1:dim(cytoCoxNumerical)[1]){
  cytoCoxRA[i,] <- cytoCoxNumerical[i,]/sum(cytoCoxNumerical[i,])
}

#Subset start and finish samples from all gene sets (for respective start and finish GHG analysis):
denitRA_start <- denitRA[c("03Pre", "06Pre", "08Pre", "09Pre", "10Pre", "11Pre", "12Pre", "16Pre"), ]
denitRA_finish <- denitRA[c("03NFC", "03PFC", "06NFC", "06PFC", "08NFC", "08PFC", "09NFC", "09PFC", "10NFC", "10PFC", "11NFC", "11PFC", "12NFC", "12PFC", "16NFC", "16PFC"), ]

methRA_start <- methRA[c("03Pre", "06Pre", "08Pre", "09Pre", "10Pre", "11Pre", "12Pre", "16Pre"), ]
methRA_finish <- methRA[c("03NFC", "03PFC", "06NFC", "06PFC", "08NFC", "08PFC", "09NFC", "09PFC", "10NFC", "10PFC", "11NFC", "11PFC", "12NFC", "12PFC", "16NFC", "16PFC"), ]

carb_metabRA_start <- carb_metabRA[c("03Pre", "06Pre", "08Pre", "09Pre", "10Pre", "11Pre", "12Pre", "16Pre"), ]
carb_metabRA_finish <- carb_metabRA[c("03NFC", "03PFC", "06NFC", "06PFC", "08NFC", "08PFC", "09NFC", "09PFC", "10NFC", "10PFC", "11NFC", "11PFC", "12NFC", "12PFC", "16NFC", "16PFC"), ]

cytoCoxRA_start <- cytoCoxRA[c("03Pre", "06Pre", "08Pre", "09Pre", "10Pre", "11Pre", "12Pre", "16Pre"), ]
cytoCoxRA_finish <- cytoCoxRA[c("03NFC", "03PFC", "06NFC", "06PFC", "08NFC", "08PFC", "09NFC", "09PFC", "10NFC", "10PFC", "11NFC", "11PFC", "12NFC", "12PFC", "16NFC", "16PFC"), ]
#Check dimensions of each relative abundance (RA) matrix:
dim(denitRA) #24 10
dim(methRA) #24 44
dim(carb_metabRA) #24 120
dim(cytoCoxRA) #24 5

dim(denitRA_start) #8 10
dim(methRA_start) #8 44
dim(carb_metabRA_start) #8 120
dim(cytoCoxRA_start) #8 5

dim(denitRA_finish) #16 10
dim(methRA_finish) #16 44
dim(carb_metabRA_finish) #16 120
dim(cytoCoxRA_finish) #16 5
```

Calculate Bray Curtis dissimilarity:
```{r}
#Bray Curtis calculation for denitrification relative abundance data:
denitBC <- vegdist(denitRA, method = "bray")
denitBC_start <- vegdist(denitRA_start, method = "bray")
denitBC_finish <- vegdist(denitRA_finish, method = "bray")
#print(denitBC)

#Bray Curtis calculation for methanogen relative abundance data:
methBC <- vegdist(methRA, method = "bray")
methBC_start <- vegdist(methRA_start, method = "bray")
methBC_finish <- vegdist(methRA_finish, method = "bray")
#print(methBC)

#Bray Curtis calculation for central carbohydrate relative abundance data:
carb_metabBC <- vegdist(carb_metabRA, method = "bray")
carb_metabBC_start <- vegdist(carb_metabRA_start, method = "bray")
carb_metabBC_finish <- vegdist(carb_metabRA_finish, method = "bray")
#print(carb_metabBC)

#Bray Curtis calculation for cytochrome C oxidase relative abundance data:
cytoCoxBC <- vegdist(cytoCoxRA, method = "bray")
cytoCoxBC_start <- vegdist(cytoCoxRA_start, method = "bray")
cytoCoxBC_finish <- vegdist(cytoCoxRA_finish, method = "bray")
#print(cytoCoxBC)
```

Wrangling GHG data:
```{r}
#Create a new GHG data frame with less columns:
GHG_less_columns <- cbind(GHG[,1:4], GHG[24:32])

#Drop rows with NAs (non-T1 rows)
GHG_less_columns <- GHG_less_columns %>% drop_na()

#Change column name "chamber" to "box" to match with design2
colnames(GHG_less_columns)[2] <- "box"

#Convert GHG_less_columns$plant to lowercase to match with design2$plant:
GHG_less_columns$plant <- tolower(GHG_less_columns$plant)

#Subset GHG_less_columns for 'start' timepoint (6/13/2016) and 'finish' (8/11/2016):
GHG_start <- GHG_less_columns[1:36,]
GHG_finish <- GHG_less_columns[157:192,]

#Add design2 into GHG 'start' and 'finish':
GHG_start <- left_join(GHG_start, design2, by = c("box", "plant"))
GHG_finish <- left_join(GHG_finish, design2, by = c("box", "plant"))

#Subset GHG_finish and GHG_start to only have metaG sample numbers:
GHG_start_metaG <- rbind(GHG_start[5:6,], GHG_start[11:12,], GHG_start[15:24,], GHG_start[31:32,], make.row.names = FALSE)
GHG_finish_metaG <- rbind(GHG_finish[5:6,], GHG_finish[11:12,], GHG_finish[15:24,], GHG_finish[31:32,], make.row.names = FALSE)

#To align "pre" metaG samples with a single, initial GHG values (from the start GHG measurements on 6/13/206), average together GHG samples in the same box number, then transpose and set row name to corresponding metaG Sample ID:
GHG_start_03 <- data.frame(colMeans(GHG_start_metaG[1:2, 5:13]))
GHG_start_03 <- as.data.frame(t(GHG_start_03))
row.names(GHG_start_03) <- "03Pre"

GHG_start_06 <- data.frame(colMeans(GHG_start_metaG[3:4, 5:13]))
GHG_start_06 <- as.data.frame(t(GHG_start_06))
row.names(GHG_start_06) <- "06Pre"

GHG_start_08 <- data.frame(colMeans(GHG_start_metaG[5:6, 5:13]))
GHG_start_08 <- as.data.frame(t(GHG_start_08))
row.names(GHG_start_08) <- "08Pre"

GHG_start_09 <- data.frame(colMeans(GHG_start_metaG[7:8, 5:13]))
GHG_start_09 <- as.data.frame(t(GHG_start_09))
row.names(GHG_start_09) <- "09Pre"

GHG_start_10 <- data.frame(colMeans(GHG_start_metaG[9:10, 5:13]))
GHG_start_10 <- as.data.frame(t(GHG_start_10))
row.names(GHG_start_10) <- "10Pre"

GHG_start_11 <- data.frame(colMeans(GHG_start_metaG[11:12, 5:13]))
GHG_start_11 <- as.data.frame(t(GHG_start_11))
row.names(GHG_start_11) <- "11Pre"

GHG_start_12 <- data.frame(colMeans(GHG_start_metaG[13:14, 5:13]))
GHG_start_12 <- as.data.frame(t(GHG_start_12))
row.names(GHG_start_12) <- "12Pre"

GHG_start_16 <- data.frame(colMeans(GHG_start_metaG[15:16, 5:13]))
GHG_start_16 <- as.data.frame(t(GHG_start_16))
row.names(GHG_start_16) <- "16Pre"

#Then rbind() all the dfs together
GHG_start_metaG_avg <- rbind(GHG_start_03, GHG_start_06, GHG_start_08, GHG_start_09, GHG_start_10, GHG_start_11, GHG_start_12, GHG_start_16)

#Set the row names of GHG data to the metaG sample names, so that stats functions can compare the GHG and metaG data sets:
row.names(GHG_finish_metaG) <- c("03NFC", "03PFC", "06NFC", "06PFC", "08NFC", "08PFC", "09NFC","09PFC", "10NFC","10PFC", "11NFC", "11PFC", "12NFC", "12PFC", "16NFC", "16PFC")

#Combine GHG_start_metaG_avg and GHG_finish_metaG[,5:13] to have all 24 samples:
GHG_metaG <- rbind(GHG_start_metaG_avg, GHG_finish_metaG[,5:13])
GHG_metaG <- GHG_metaG[match(sample_order, rownames(GHG_metaG)), ]
```

Distance-based partial least squares regression:
```{r}
library(dbstats)

start.denit.dbplsr <- dbplsr(GHG_start_metaG_avg$mg.N2O.N.m.2 ~ as.matrix(denitBC_start), ncomp = 6, method = "GCV")
summary(start.denit.dbplsr)
#plot(start.denit.dbplsr)

finish.denit.dbplsr <- dbplsr(GHG_finish_metaG$mg.N2O.N.m.2 ~ as.matrix(denitBC_finish), ncomp = 6, method = "GCV")
summary(finish.denit.dbplsr)
#plot(finish.denit.dbplsr)

start.meth.dbplsr <- dbplsr(GHG_start_metaG_avg$mg.CH4.N.m.2 ~ as.matrix(methBC_start), ncomp = 6, method = "GCV")
summary(start.meth.dbplsr)
#plot(start.meth.dbplsr)

finish.meth.dbplsr <- dbplsr(GHG_finish_metaG$mg.CH4.N.m.2 ~ as.matrix(methBC_finish), ncomp = 6, method = "GCV")
summary(finish.meth.dbplsr)
#plot(finish.meth.dbplsr)

start.carb_metab.dbplsr <- dbplsr(GHG_start_metaG_avg$mg.CO2.N.m.2 ~ as.matrix(carb_metabBC_start), ncomp = 6, method = "GCV")
summary(start.carb_metab.dbplsr)
#plot(start.carb_metab.dbplsr)

finish.carb_metab.dbplsr <- dbplsr(GHG_finish_metaG$mg.CO2.N.m.2 ~ as.matrix(carb_metabBC_finish), ncomp = 6, method = "GCV")
summary(finish.carb_metab.dbplsr)
#plot(finish.carb_metab.dbplsr)

start.cytoCox.dbplsr <- dbplsr(GHG_start_metaG_avg$mg.CO2.N.m.2 ~ as.matrix(cytoCoxBC_start), ncomp = 6, method = "GCV")
summary(start.cytoCox.dbplsr)
#plot(start.cytoCox.dbplsr)

finish.cytoCox.dbplsr <- dbplsr(GHG_finish_metaG$mg.CO2.N.m.2 ~ as.matrix(cytoCoxBC_finish), ncomp = 6, method = "GCV")
summary(finish.cytoCox.dbplsr)
#plot(finish.cytoCox.dbplsr)

# Because of envfit() results showing significant relationship between denitrification composition and [CO2], running dbplsrs for denit and CO2:
start.denit.dbplsr.co2 <- dbplsr(GHG_start_metaG_avg$mg.CO2.N.m.2 ~ as.matrix(denitBC_start), ncomp = 6, method = "GCV")
summary(start.denit.dbplsr.co2)
#plot(start.denit.dbplsr.co2)

finish.denit.dbplsr.co2 <- dbplsr(GHG_finish_metaG$mg.CO2.N.m.2 ~ as.matrix(denitBC_finish), ncomp = 6, method = "GCV")
summary(finish.denit.dbplsr.co2)
#plot(finish.denit.dbplsr.co2)
```

PERMANOVA:
```{r}
#Make metaG sample ID's the rownames on 'design'. Then drop design$Sample:
rownames(design) <- design$Sample
design <- design[,2:4]

# Make data frames from gene set relative abundance (RA) files and design
denitRA_design <- cbind(design, denitRA)
methRA_design <- cbind(design, methRA)
carb_metabRA_design <- cbind(design, carb_metabRA)
cytoCoxRA_design <- cbind(design, cytoCoxRA)

#PERMANOVA:
adonis_denit_interaction = adonis(denitRA_design[,-c(1:3)]~Treat*Hist*Plant, method = "bray", data = denitRA_design, perm=10000) #Testing 10,000 permutations
adonis_denit_interaction # Did not take much longer to run, but P-values are nearly equal

adonis_denit_main = adonis(denitRA_design[,-c(1:3)]~Treat+Hist+Plant, method = "bray", data = denitRA_design, perm=10000)
adonis_denit_main

adonis_meth_interactive = adonis(methRA_design[,-c(1:3)]~Treat*Hist*Plant, method = "bray", data = methRA_design, perm=10000)
adonis_meth_interactive

adonis_meth_main = adonis(methRA_design[,-c(1:3)]~Treat+Hist+Plant, method = "bray", data = methRA_design, perm=10000)
adonis_meth_main

adonis_carb_metab_interactive = adonis(carb_metabRA_design[,-c(1:3)]~Treat*Hist*Plant, method = "bray", data = carb_metabRA_design, perm=10000)
adonis_carb_metab_interactive

adonis_carb_metab_main = adonis(carb_metabRA_design[,-c(1:3)]~Treat+Hist+Plant, method = "bray", data = carb_metabRA_design, perm=10000)
adonis_carb_metab_main

adonis_cytoCox_interactive = adonis(cytoCoxRA_design[,-c(1:3)]~Treat*Hist*Plant, method = "bray", data = cytoCoxRA_design, perm=10000)
adonis_cytoCox_interactive

adonis_cytoCox_main = adonis(cytoCoxRA_design[,-c(1:3)]~Treat+Hist+Plant, method = "bray", data = cytoCoxRA_design, perm=10000)
adonis_cytoCox_main
```

Principal Coordinates Analysis (PCoA) denitrification:
```{r}
# Classical (Metric) Multidimensional Scaling; returns PCoA coordinates
# eig=TRUE returns eigenvalues; k = # of dimensions to calculate
pcoa_denit <- cmdscale(denitBC, k=3, eig=TRUE, add=FALSE)

explainvar1b_denit <- round(pcoa_denit$eig[1] / sum(pcoa_denit$eig), 3) * 100
explainvar2b_denit <- round(pcoa_denit$eig[2] / sum(pcoa_denit$eig), 3) * 100
sum.eigb <- sum(explainvar1b_denit, explainvar2b_denit)

explainvar1b_denit # 44.6
explainvar2b_denit # 25.1

pcoa_denit.groups <- paste(denitRA_design$Treat, denitRA_design$Plant, sep = "_")
pcoa_denit.points <- data.frame(pcoa_denit$points, group = pcoa_denit.groups)

# Calculate Centroids (mean and SE)
pcoa_denit.L.centroids <- reshape2::melt(pcoa_denit.points, id="group", measure.vars = c("X1", "X2"))
pcoa_denit.centroids <- acast(pcoa_denit.L.centroids, variable ~ group, mean)
pcoa_denit.centroids.se <- acast(pcoa_denit.L.centroids, variable ~ group, se)
pcoa_denit.centroids.sd <- acast(pcoa_denit.L.centroids, variable ~ group, sd)

# Combine
pcoa_denit.cent.dataframe <- cbind(t(pcoa_denit.centroids), t(pcoa_denit.centroids.se))
colnames(pcoa_denit.cent.dataframe) <- c("V1", "V2", "V1e", "V2e")

trt <- c("baseline","dry","dry","wet","wet") #this should match the treatments from pcoa_denit.cent.dataframe
plant <- c("baseline","no plant","plant","no plant","plant") #this should match the treatments from pcoa_denit.cent.dataframe

pcoa_denit.cent.dataframe.trts <- as.data.frame(pcoa_denit.cent.dataframe) 
pcoa_denit.cent.dataframe.trts$trt <- as.factor(trt) # now you add the new columns that you made above to the pcoa.cent.dataframe.trts df
pcoa_denit.cent.dataframe.trts$plant <- as.factor(plant)

#Plot using ggplot2
df1a <- as.data.frame(pcoa_denit.cent.dataframe.trts)
plot1a <- ggplot(df1a, aes(x=V1, y=V2, colour=trt, shape = plant)) + theme_bw() 
plot1a + theme(panel.grid.major = element_blank(), 
               panel.grid.minor = element_blank(), 
               axis.line = element_line(colour = "black")) + 
  theme(panel.background = element_blank()) + 
  geom_errorbarh(aes(xmax=V1+V1e, xmin=V1-V1e), colour="black") + 
  geom_errorbar(aes(ymax=V2+V2e, ymin=V2-V2e), colour="black") +
  geom_point(aes(colour=trt), size=5, stroke = 1.25, show.legend = TRUE) +
  scale_colour_manual(labels = c("baseline","dry","wet"), 
                      values = c("gray70", "cyan", "darkblue")) +
  scale_shape_manual(labels = c("baseline","no plant","plant"), values = c(16,22,15)) +
  theme(axis.title = element_text(size=14), 
        axis.text = element_text(size=14),
        axis.text.x = element_text(size=14), 
        panel.border = element_rect(colour = "black", size = 1.25)) + 
  theme(axis.ticks.length = unit(0.3, "cm")) + 
        xlab("PCoA 1 (44.6%)") + ylab("PCoA 2 (25.1%)") +
        labs(colour = "Hydrologic Treatment", shape = "Plant") +
    guides(colour = guide_legend(override.aes = list(pch=16, size = 4)),
           shape = guide_legend(override.aes = list(size = 4))) +
    ggtitle("Denitrifier Community Composition")
#ggsave("../figures/DNFcomposition1a.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
```
Principal Coordinates Analysis (PCoA) denitrification, including hydrologic history and envfit:
```{r}
# Classical (Metric) Multidimensional Scaling; returns PCoA coordinates
# eig=TRUE returns eigenvalues; k = # of dimensions to calculate
pcoa_denit <- cmdscale(denitBC, k=3, eig=TRUE, add=FALSE)

explainvar1b_denit <- round(pcoa_denit$eig[1] / sum(pcoa_denit$eig), 3) * 100
explainvar2b_denit <- round(pcoa_denit$eig[2] / sum(pcoa_denit$eig), 3) * 100
sum.eigb <- sum(explainvar1b_denit, explainvar2b_denit)

explainvar1b_denit # 44.6
explainvar2b_denit # 25.1

pcoa_denit2.groups <- paste(denitRA_design$Treat, denitRA_design$Plant, denitRA_design$Hist, sep = "_")
pcoa_denit2.points <- data.frame(pcoa_denit$points, group = pcoa_denit2.groups)

# Calculate Centroids (mean and SE)
pcoa_denit2.L.centroids <- reshape2::melt(pcoa_denit2.points, id="group", measure.vars = c("X1", "X2"))
pcoa_denit2.centroids <- acast(pcoa_denit2.L.centroids, variable ~ group, mean)
pcoa_denit2.centroids.se <- acast(pcoa_denit2.L.centroids, variable ~ group, se)
pcoa_denit2.centroids.sd <- acast(pcoa_denit2.L.centroids, variable ~ group, sd)

# Combine
pcoa_denit2.cent.dataframe <- cbind(t(pcoa_denit2.centroids), t(pcoa_denit2.centroids.se))
colnames(pcoa_denit2.cent.dataframe) <- c("V1", "V2", "V1e", "V2e")

trt <- c("baseline", "baseline", "dry","dry", "dry","dry","wet","wet", "wet","wet") 
plant <- c("baseline", "baseline", "no plant","no plant","plant", "plant", "no plant","no plant","plant", "plant")
history <- c("D", "W", "D", "W", "D", "W", "D", "W", "D", "W")
hydro_combined <- c(paste(trt, history, sep = "_"))

pcoa_denit2.cent.dataframe.trts <- as.data.frame(pcoa_denit2.cent.dataframe) 
pcoa_denit2.cent.dataframe.trts$trt <- as.factor(trt) # now you add the new columns that you made above to the pcoa.cent.dataframe.trts df
pcoa_denit2.cent.dataframe.trts$plant <- as.factor(plant)
pcoa_denit2.cent.dataframe.trts$history <- as.factor(history)
pcoa_denit2.cent.dataframe.trts$hydro_combined <- as.factor(hydro_combined)

#Run envfit to see which [GHG]s (start or finish) are explained by ordination:
#fit_denit2 <- envfit(pcoa_denit$points, GHG_metaG$mg.N2O.N.m.2, permutations = 1000) # Could use if I wanted only [N2O]
fit_denit2 <- envfit(pcoa_denit$points, GHG_metaG, permutations = 1000)
fit_denit2

A_denit2 <-as.list(fit_denit2$vectors)
vec_denit2 <- as.data.frame(fit_denit2$vectors$arrows*sqrt(fit_denit2$vectors$r)*0.35) #What is this calculation?
p_denit2 <- as.data.frame(A_denit2$pvals)
vec_denit2 <- cbind(vec_denit2, p_denit2)
vec_denit2 <- subset(vec_denit2, A_denit2$pvals<=0.05)
vec_denit2 <- vec_denit2[2, ] #Only use mg of gas, instead of ug or g

#Plot using ggplot2
df1b <- as.data.frame(pcoa_denit2.cent.dataframe.trts)
plot1b <- ggplot(df1b, aes(x=V1, y=V2, colour=hydro_combined, shape = plant)) + theme_bw() 
plot1b + theme(panel.grid.major = element_blank(), 
               panel.grid.minor = element_blank(), 
               axis.line = element_line(colour = "black")) + 
  theme(panel.background = element_blank()) + 
  geom_errorbarh(aes(xmax=V1+V1e, xmin=V1-V1e), colour="black") + 
  geom_errorbar(aes(ymax=V2+V2e, ymin=V2-V2e), colour="black") +
  geom_point(aes(colour=hydro_combined, shape=plant), size=5, stroke = 1.25, show.legend = TRUE) +
  geom_segment(data=vec_denit2, aes(x=0,xend=Dim1,y=0,yend=Dim2), size=1, 
      arrow = arrow(length = unit(0.2, "cm")),colour="black",inherit.aes=F)+
  geom_text(data=vec_denit2, aes(x=0.03,y=-0.15,label="mg.CO2.N.m.2"), size=5, inherit.aes=F)+
  scale_colour_manual(labels = c("baseline_D", "baseline_W", "dry_D", "dry_W", "wet_D", "wet_W"), 
                      values = c("gray70", "grey28", "paleturquoise", "deepskyblue", "blue", "midnightblue")) +
  scale_shape_manual(labels = c("baseline","no plant","plant"), values = c(16,22,15)) +
  theme(axis.title = element_text(size=14), 
        axis.text = element_text(size=14),
        axis.text.x = element_text(size=14), 
        panel.border = element_rect(colour = "black", size = 1.25)) + 
  theme(axis.ticks.length = unit(0.3, "cm")) + 
        xlab("PCoA 1 (44.6%)") + ylab("PCoA 2 (25.1%)") +
        labs(colour = "Hydrology (treatment_history)", shape = "Plant") +
    guides(colour = guide_legend(override.aes = list(pch=16, size = 4)),
           shape = guide_legend(override.aes = list(size = 4))) +
    ggtitle("Denitrifier Community Composition")
#ggsave("../figures/DNFcomposition1b.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
```

Principal Coordinates Analysis (PCoA) methanogenesis:
```{r}
# Classical (Metric) Multidimensional Scaling; returns PCoA coordinates
# eig=TRUE returns eigenvalues; k = # of dimensions to calculate
pcoa_meth <- cmdscale(methBC, k=3, eig=TRUE, add=FALSE)

explainvar1b_meth <- round(pcoa_meth$eig[1] / sum(pcoa_meth$eig), 3) * 100
explainvar2b_meth <- round(pcoa_meth$eig[2] / sum(pcoa_meth$eig), 3) * 100
sum.eigb <- sum(explainvar1b_meth, explainvar2b_meth)

explainvar1b_meth # 41.3
explainvar2b_meth # 27.8

pcoa_meth.groups <- paste(methRA_design$Treat, methRA_design$Plant, sep = "_")
pcoa_meth.points <- data.frame(pcoa_meth$points, group = pcoa_meth.groups)

# Calculate Centroids (mean and SE)
pcoa_meth.L.centroids <- reshape2::melt(pcoa_meth.points, id="group", measure.vars = c("X1", "X2"))
pcoa_meth.centroids <- acast(pcoa_meth.L.centroids, variable ~ group, mean)
pcoa_meth.centroids.se <- acast(pcoa_meth.L.centroids, variable ~ group, se)
pcoa_meth.centroids.sd <- acast(pcoa_meth.L.centroids, variable ~ group, sd)

# Combine
pcoa_meth.cent.dataframe <- cbind(t(pcoa_meth.centroids), t(pcoa_meth.centroids.se))
colnames(pcoa_meth.cent.dataframe) <- c("V1", "V2", "V1e", "V2e")

trt <- c("baseline","dry","dry","wet","wet") 
plant <- c("baseline","no plant","plant","no plant","plant")

pcoa_meth.cent.dataframe.trts <- as.data.frame(pcoa_meth.cent.dataframe) 
pcoa_meth.cent.dataframe.trts$trt <- as.factor(trt) # now you add the new columns that you made above to the pcoa.cent.dataframe.trts df
pcoa_meth.cent.dataframe.trts$plant <- as.factor(plant)

#Plot using ggplot2
df2a <- as.data.frame(pcoa_meth.cent.dataframe.trts)
plot2a <- ggplot(df2a, aes(x=V1, y=V2, colour=trt, shape = plant)) + theme_bw() 
plot2a + theme(panel.grid.major = element_blank(), 
               panel.grid.minor = element_blank(), 
               axis.line = element_line(colour = "black")) + 
  theme(panel.background = element_blank()) + 
  geom_errorbarh(aes(xmax=V1+V1e, xmin=V1-V1e), colour="black") + 
  geom_errorbar(aes(ymax=V2+V2e, ymin=V2-V2e), colour="black") +
  geom_point(aes(colour=trt), size=5, stroke = 1.25, show.legend = TRUE) +
  scale_colour_manual(labels = c("baseline","dry","wet"), 
                      values = c("gray70", "cyan", "darkblue")) +
  scale_shape_manual(labels = c("baseline","no plant","plant"), values = c(16,22,15)) +
  theme(axis.title = element_text(size=14), 
        axis.text = element_text(size=14),
        axis.text.x = element_text(size=14), 
        panel.border = element_rect(colour = "black", size = 1.25)) + 
  theme(axis.ticks.length = unit(0.3, "cm")) + 
        xlab("PCoA 1 (41.3%)") + ylab("PCoA 2 (27.8%)") +
        labs(colour = "Hydrologic Treatment", shape = "Plant") +
    guides(colour = guide_legend(override.aes = list(pch=16, size = 4)),
           shape = guide_legend(override.aes = list(size = 4))) +
    ggtitle("Methanogen Community Composition")
#ggsave("../figures/METHcomposition2a.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
```
Principal Coordinates Analysis (PCoA) methanogenis, including hydrologic history and envfit:
```{r}
# Classical (Metric) Multidimensional Scaling; returns PCoA coordinates
# eig=TRUE returns eigenvalues; k = # of dimensions to calculate
pcoa_meth <- cmdscale(methBC, k=3, eig=TRUE, add=FALSE)

explainvar1b_meth <- round(pcoa_meth$eig[1] / sum(pcoa_meth$eig), 3) * 100
explainvar2b_meth <- round(pcoa_meth$eig[2] / sum(pcoa_meth$eig), 3) * 100
sum.eigb <- sum(explainvar1b_meth, explainvar2b_meth)

explainvar1b_meth # 41.3
explainvar2b_meth # 27.8

pcoa_meth2.groups <- paste(methRA_design$Treat, methRA_design$Plant, methRA_design$Hist, sep = "_")
pcoa_meth2.points <- data.frame(pcoa_meth$points, group = pcoa_meth2.groups)

# Calculate Centroids (mean and SE)
pcoa_meth2.L.centroids <- reshape2::melt(pcoa_meth2.points, id="group", measure.vars = c("X1", "X2"))
pcoa_meth2.centroids <- acast(pcoa_meth2.L.centroids, variable ~ group, mean)
pcoa_meth2.centroids.se <- acast(pcoa_meth2.L.centroids, variable ~ group, se)
pcoa_meth2.centroids.sd <- acast(pcoa_meth2.L.centroids, variable ~ group, sd)

# Combine
pcoa_meth2.cent.dataframe <- cbind(t(pcoa_meth2.centroids), t(pcoa_meth2.centroids.se))
colnames(pcoa_meth2.cent.dataframe) <- c("V1", "V2", "V1e", "V2e")

#trt <- c("baseline", "baseline", "dry","dry", "dry","dry","wet","wet", "wet","wet") 
#plant <- c("baseline", "baseline", "no plant","no plant","plant", "plant", "no plant","no plant","plant", "plant")
#history <- c("D", "W", "D", "W", "D", "W", "D", "W", "D", "W")
#hydro_combined <- c(paste(trt, history, sep = "_"))

pcoa_meth2.cent.dataframe.trts <- as.data.frame(pcoa_meth2.cent.dataframe) 
pcoa_meth2.cent.dataframe.trts$trt <- as.factor(trt) # now you add the new columns that you made above to the pcoa.cent.dataframe.trts df
pcoa_meth2.cent.dataframe.trts$plant <- as.factor(plant)
pcoa_meth2.cent.dataframe.trts$history <- as.factor(history)
pcoa_meth2.cent.dataframe.trts$hydro_combined <- as.factor(hydro_combined)

#Run envfit to see which [GHG]s (start or finish) are explained by ordination:
fit_meth2 <- envfit(pcoa_meth$points, GHG_metaG, permutations = 1000)
fit_meth2 # No significant P-values, so not proceeding with envfit plotting for now

#A_meth2 <-as.list(fit_meth2$vectors)
#vec_meth2 <- as.data.frame(fit_meth2$vectors$arrows*sqrt(fit_meth2$vectors$r)*0.35) #What is this calculation?
#p_meth2 <- as.data.frame(A_meth2$pvals)
#vec_meth2 <- cbind(vec_meth2, p_meth2)
#vec_meth2 <- subset(vec_meth2, A_meth2$pvals<=0.05)
#vec_meth2 <- vec_meth2[2, ] #Only use mg of gas, instead of ug or g

#Plot using ggplot2
df2b <- as.data.frame(pcoa_meth2.cent.dataframe.trts)
plot2b <- ggplot(df2b, aes(x=V1, y=V2, colour=hydro_combined, shape = plant)) + theme_bw() 
plot2b + theme(panel.grid.major = element_blank(), 
               panel.grid.minor = element_blank(), 
               axis.line = element_line(colour = "black")) + 
  theme(panel.background = element_blank()) + 
  geom_errorbarh(aes(xmax=V1+V1e, xmin=V1-V1e), colour="black") + 
  geom_errorbar(aes(ymax=V2+V2e, ymin=V2-V2e), colour="black") +
  geom_point(aes(colour=hydro_combined, shape=plant), size=5, stroke = 1.25, show.legend = TRUE) +
  #geom_segment(data=vec_meth2, aes(x=0,xend=Dim1,y=0,yend=Dim2), size=1, 
      #arrow = arrow(length = unit(0.2, "cm")),colour="black",inherit.aes=F)+
  #geom_text(data=vec_meth2, aes(x=0.03,y=-0.15,label="mg.CO2.N.m.2"), size=5, inherit.aes=F)+
  scale_colour_manual(labels = c("baseline_D", "baseline_W", "dry_D", "dry_W", "wet_D", "wet_W"), 
                      values = c("gray70", "grey28", "paleturquoise", "deepskyblue", "blue", "midnightblue")) +
  scale_shape_manual(labels = c("baseline","no plant","plant"), values = c(16,22,15)) +
  theme(axis.title = element_text(size=14), 
        axis.text = element_text(size=14),
        axis.text.x = element_text(size=14), 
        panel.border = element_rect(colour = "black", size = 1.25)) + 
  theme(axis.ticks.length = unit(0.3, "cm")) + 
        xlab("PCoA 1 (41.3%)") + ylab("PCoA 2 (27.8%)") +
        labs(colour = "Hydrology (treatment_history)", shape = "Plant") +
    guides(colour = guide_legend(override.aes = list(pch=16, size = 4)),
           shape = guide_legend(override.aes = list(size = 4))) +
    ggtitle("Methanogen Community Composition")
#ggsave("../figures/METHcomposition2b.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
```

Principal Coordinates Analysis (PCoA) central carbohydrate metabolism:
```{r}
# Classical (Metric) Multidimensional Scaling; returns PCoA coordinates
# eig=TRUE returns eigenvalues; k = # of dimensions to calculate
pcoa_carb_metab <- cmdscale(carb_metabBC, k=3, eig=TRUE, add=FALSE)

explainvar1b_carb_metab <- round(pcoa_carb_metab$eig[1] / sum(pcoa_carb_metab$eig), 3) * 100
explainvar2b_carb_metab <- round(pcoa_carb_metab$eig[2] / sum(pcoa_carb_metab$eig), 3) * 100
sum.eigb <- sum(explainvar1b_carb_metab, explainvar2b_carb_metab)

explainvar1b_carb_metab # 33.7
explainvar2b_carb_metab # 15.9

pcoa_carb_metab.groups <- paste(carb_metabRA_design$Treat, carb_metabRA_design$Plant, sep = "_")
pcoa_carb_metab.points <- data.frame(pcoa_carb_metab$points, group = pcoa_carb_metab.groups)

# Calculate Centroids (mean and SE)
pcoa_carb_metab.L.centroids <- reshape2::melt(pcoa_carb_metab.points, id="group", measure.vars = c("X1", "X2"))
pcoa_carb_metab.centroids <- acast(pcoa_carb_metab.L.centroids, variable ~ group, mean)
pcoa_carb_metab.centroids.se <- acast(pcoa_carb_metab.L.centroids, variable ~ group, se)
pcoa_carb_metab.centroids.sd <- acast(pcoa_carb_metab.L.centroids, variable ~ group, sd)

# Combine
pcoa_carb_metab.cent.dataframe <- cbind(t(pcoa_carb_metab.centroids), t(pcoa_carb_metab.centroids.se))
colnames(pcoa_carb_metab.cent.dataframe) <- c("V1", "V2", "V1e", "V2e")

trt <- c("baseline","dry","dry","wet","wet")
plant <- c("baseline","no plant","plant","no plant","plant")

pcoa_carb_metab.cent.dataframe.trts <- as.data.frame(pcoa_carb_metab.cent.dataframe) 
pcoa_carb_metab.cent.dataframe.trts$trt <- as.factor(trt) # now you add the new columns that you made above to the pcoa.cent.dataframe.trts df
pcoa_carb_metab.cent.dataframe.trts$plant <- as.factor(plant)

#Plot using ggplot2
df3a <- as.data.frame(pcoa_carb_metab.cent.dataframe.trts)
plot3a <- ggplot(df3a, aes(x=V1, y=V2, colour=trt, shape = plant)) + theme_bw() 
plot3a + theme(panel.grid.major = element_blank(), 
               panel.grid.minor = element_blank(), 
               axis.line = element_line(colour = "black")) + 
  theme(panel.background = element_blank()) + 
  geom_errorbarh(aes(xmax=V1+V1e, xmin=V1-V1e), colour="black") + 
  geom_errorbar(aes(ymax=V2+V2e, ymin=V2-V2e), colour="black") +
  geom_point(aes(colour=trt), size=5, stroke = 1.25, show.legend = TRUE) +
  scale_colour_manual(labels = c("baseline","dry","wet"), 
                      values = c("gray70", "cyan", "darkblue")) +
  scale_shape_manual(labels = c("baseline","no plant","plant"), values = c(16,22,15)) +
  theme(axis.title = element_text(size=14), 
        axis.text = element_text(size=14),
        axis.text.x = element_text(size=14), 
        panel.border = element_rect(colour = "black", size = 1.25)) + 
  theme(axis.ticks.length = unit(0.3, "cm")) + 
        xlab("PCoA 1 (33.7%)") + ylab("PCoA 2 (15.9%)") +
        labs(colour = "Hydrologic Treatment", shape = "Plant") +
    guides(colour = guide_legend(override.aes = list(pch=16, size = 4)),
           shape = guide_legend(override.aes = list(size = 4))) +
    ggtitle("Central Carbohydrate Metabolism Community Composition")
#ggsave("../figures/CARBcomposition3a.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
```
Principal Coordinates Analysis (PCoA) central carbohydrate metabolism with hydrologic history and envfit:
```{r}
# Classical (Metric) Multidimensional Scaling; returns PCoA coordinates
# eig=TRUE returns eigenvalues; k = # of dimensions to calculate
pcoa_carb_metab <- cmdscale(carb_metabBC, k=3, eig=TRUE, add=FALSE)

explainvar1b_carb_metab <- round(pcoa_carb_metab$eig[1] / sum(pcoa_carb_metab$eig), 3) * 100
explainvar2b_carb_metab <- round(pcoa_carb_metab$eig[2] / sum(pcoa_carb_metab$eig), 3) * 100
sum.eigb <- sum(explainvar1b_carb_metab, explainvar2b_carb_metab)

explainvar1b_carb_metab # 33.7
explainvar2b_carb_metab # 15.9

pcoa_carb_metab2.groups <- paste(carb_metabRA_design$Treat, carb_metabRA_design$Plant, carb_metabRA_design$Hist, sep = "_")
pcoa_carb_metab2.points <- data.frame(pcoa_carb_metab$points, group = pcoa_carb_metab2.groups)

# Calculate Centroids (mean and SE)
pcoa_carb_metab2.L.centroids <- reshape2::melt(pcoa_carb_metab2.points, id="group", measure.vars = c("X1", "X2"))
pcoa_carb_metab2.centroids <- acast(pcoa_carb_metab2.L.centroids, variable ~ group, mean)
pcoa_carb_metab2.centroids.se <- acast(pcoa_carb_metab2.L.centroids, variable ~ group, se)
pcoa_carb_metab2.centroids.sd <- acast(pcoa_carb_metab2.L.centroids, variable ~ group, sd)

# Combine
pcoa_carb_metab2.cent.dataframe <- cbind(t(pcoa_carb_metab2.centroids), t(pcoa_carb_metab2.centroids.se))
colnames(pcoa_carb_metab2.cent.dataframe) <- c("V1", "V2", "V1e", "V2e")

#trt <- c("baseline", "baseline", "dry","dry", "dry","dry","wet","wet", "wet","wet") 
#plant <- c("baseline", "baseline", "no plant","no plant","plant", "plant", "no plant","no plant","plant", "plant")
#history <- c("D", "W", "D", "W", "D", "W", "D", "W", "D", "W")
#hydro_combined <- c(paste(trt, history, sep = "_"))

pcoa_carb_metab2.cent.dataframe.trts <- as.data.frame(pcoa_carb_metab2.cent.dataframe) 
pcoa_carb_metab2.cent.dataframe.trts$trt <- as.factor(trt) # now you add the new columns that you made above to the pcoa.cent.dataframe.trts df
pcoa_carb_metab2.cent.dataframe.trts$plant <- as.factor(plant)
pcoa_carb_metab2.cent.dataframe.trts$history <- as.factor(history)
pcoa_carb_metab2.cent.dataframe.trts$hydro_combined <- as.factor(hydro_combined)

#Run envfit to see which [GHG]s (start or finish) are explained by ordination:
fit_carb_metab2 <- envfit(pcoa_carb_metab$points, GHG_metaG, permutations = 1000)
fit_carb_metab2 # No significant P-values, so not proceeding with envfit plotting for now

#A_carb_metab2 <-as.list(fit_carb_metab2$vectors)
#vec_carb_metab2 <- as.data.frame(fit_carb_metab2$vectors$arrows*sqrt(fit_carb_metab2$vectors$r)*0.35) #What is this calculation?
#p_carb_metab2 <- as.data.frame(A_carb_metab2$pvals)
#vec_carb_metab2 <- cbind(vec_carb_metab2, p_carb_metab2)
#vec_carb_metab2 <- subset(vec_carb_metab2, A_carb_metab2$pvals<=0.05)
#vec_carb_metab2 <- vec_carb_metab2[2, ] #Only use mg of gas, instead of ug or g

#Plot using ggplot2
df3b <- as.data.frame(pcoa_carb_metab2.cent.dataframe.trts)
plot3b <- ggplot(df3b, aes(x=V1, y=V2, colour=hydro_combined, shape = plant)) + theme_bw() 
plot3b + theme(panel.grid.major = element_blank(), 
               panel.grid.minor = element_blank(), 
               axis.line = element_line(colour = "black")) + 
  theme(panel.background = element_blank()) + 
  geom_errorbarh(aes(xmax=V1+V1e, xmin=V1-V1e), colour="black") + 
  geom_errorbar(aes(ymax=V2+V2e, ymin=V2-V2e), colour="black") +
  geom_point(aes(colour=hydro_combined, shape=plant), size=5, stroke = 1.25, show.legend = TRUE) +
  #geom_segment(data=vec_carb_metab2, aes(x=0,xend=Dim1,y=0,yend=Dim2), size=1, 
      #arrow = arrow(length = unit(0.2, "cm")),colour="black",inherit.aes=F)+
  #geom_text(data=vec_carb_metab2, aes(x=0.03,y=-0.15,label="mg.CO2.N.m.2"), size=5, inherit.aes=F)+
  scale_colour_manual(labels = c("baseline_D", "baseline_W", "dry_D", "dry_W", "wet_D", "wet_W"), 
                      values = c("gray70", "grey28", "paleturquoise", "deepskyblue", "blue", "midnightblue")) +
  scale_shape_manual(labels = c("baseline","no plant","plant"), values = c(16,22,15)) +
  theme(axis.title = element_text(size=14), 
        axis.text = element_text(size=14),
        axis.text.x = element_text(size=14), 
        panel.border = element_rect(colour = "black", size = 1.25)) + 
  theme(axis.ticks.length = unit(0.3, "cm")) + 
        xlab("PCoA 1 (33.7%)") + ylab("PCoA 2 (15.9%)") +
        labs(colour = "Hydrology (treatment_history)", shape = "Plant") +
    guides(colour = guide_legend(override.aes = list(pch=16, size = 4)),
           shape = guide_legend(override.aes = list(size = 4))) +
    ggtitle("Central Carbohydrate Metabolism Community Composition")
#ggsave("../figures/CARBcomposition3b.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
```

Principal Coordinates Analysis (PCoA) cytochrome C oxidase:
```{r}
# Classical (Metric) Multidimensional Scaling; returns PCoA coordinates
# eig=TRUE returns eigenvalues; k = # of dimensions to calculate
pcoa_cytoCox <- cmdscale(cytoCoxBC, k=3, eig=TRUE, add=FALSE)

explainvar1b_cytoCox <- round(pcoa_cytoCox$eig[1] / sum(pcoa_cytoCox$eig), 3) * 100
explainvar2b_cytoCox <- round(pcoa_cytoCox$eig[2] / sum(pcoa_cytoCox$eig), 3) * 100
sum.eigb <- sum(explainvar1b_cytoCox, explainvar2b_cytoCox)

explainvar1b_cytoCox # 50.7
explainvar2b_cytoCox # 35.6

pcoa_cytoCox.groups <- paste(cytoCoxRA_design$Treat, cytoCoxRA_design$Plant, sep = "_")
pcoa_cytoCox.points <- data.frame(pcoa_cytoCox$points, group = pcoa_cytoCox.groups)

# Calculate Centroids (mean and SE)
pcoa_cytoCox.L.centroids <- reshape2::melt(pcoa_cytoCox.points, id="group", measure.vars = c("X1", "X2"))
pcoa_cytoCox.centroids <- acast(pcoa_cytoCox.L.centroids, variable ~ group, mean)
pcoa_cytoCox.centroids.se <- acast(pcoa_cytoCox.L.centroids, variable ~ group, se)
pcoa_cytoCox.centroids.sd <- acast(pcoa_cytoCox.L.centroids, variable ~ group, sd)

# Combine
pcoa_cytoCox.cent.dataframe <- cbind(t(pcoa_cytoCox.centroids), t(pcoa_cytoCox.centroids.se))
colnames(pcoa_cytoCox.cent.dataframe) <- c("V1", "V2", "V1e", "V2e")

trt <- c("baseline","dry","dry","wet","wet")
plant <- c("baseline","no plant","plant","no plant","plant")

pcoa_cytoCox.cent.dataframe.trts <- as.data.frame(pcoa_cytoCox.cent.dataframe) 
pcoa_cytoCox.cent.dataframe.trts$trt <- as.factor(trt) # now you add the new columns that you made above to the pcoa.cent.dataframe.trts df
pcoa_cytoCox.cent.dataframe.trts$plant <- as.factor(plant)

#Plot using ggplot2
df4a <- as.data.frame(pcoa_cytoCox.cent.dataframe.trts)
plot4a <- ggplot(df4a, aes(x=V1, y=V2, colour=trt, shape = plant)) + theme_bw() 
plot4a + theme(panel.grid.major = element_blank(), 
               panel.grid.minor = element_blank(), 
               axis.line = element_line(colour = "black")) + 
  theme(panel.background = element_blank()) + 
  geom_errorbarh(aes(xmax=V1+V1e, xmin=V1-V1e), colour="black") + 
  geom_errorbar(aes(ymax=V2+V2e, ymin=V2-V2e), colour="black") +
  geom_point(aes(colour=trt), size=5, stroke = 1.25, show.legend = TRUE) +
  scale_colour_manual(labels = c("baseline","dry","wet"), 
                      values = c("gray70", "cyan", "darkblue")) +
  scale_shape_manual(labels = c("baseline","no plant","plant"), values = c(16,22,15)) +
  theme(axis.title = element_text(size=14), 
        axis.text = element_text(size=14),
        axis.text.x = element_text(size=14), 
        panel.border = element_rect(colour = "black", size = 1.25)) + 
  theme(axis.ticks.length = unit(0.3, "cm")) + 
        xlab("PCoA 1 (50.7%)") + ylab("PCoA 2 (35.6%)") +
        labs(colour = "Hydrologic Treatment", shape = "Plant") +
    guides(colour = guide_legend(override.aes = list(pch=16, size = 4)),
           shape = guide_legend(override.aes = list(size = 4))) +
    ggtitle("Cytochrome C Oxidase Community Composition")
#ggsave("../figures/CcOcomposition4a.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
```
Principal Coordinates Analysis (PCoA) cytochrome C oxidase, adding History as text labels:
```{r}
# Classical (Metric) Multidimensional Scaling; returns PCoA coordinates
# eig=TRUE returns eigenvalues; k = # of dimensions to calculate
pcoa_cytoCox2 <- cmdscale(cytoCoxBC, k=3, eig=TRUE, add=FALSE)

explainvar1b_cytoCox2 <- round(pcoa_cytoCox2$eig[1] / sum(pcoa_cytoCox2$eig), 3) * 100
explainvar2b_cytoCox2 <- round(pcoa_cytoCox2$eig[2] / sum(pcoa_cytoCox2$eig), 3) * 100
sum.eigb <- sum(explainvar1b_cytoCox2, explainvar2b_cytoCox2)

explainvar1b_cytoCox2 # 50.7
explainvar2b_cytoCox2 # 35.6

pcoa_cytoCox2.groups <- paste(cytoCoxRA_design$Treat, cytoCoxRA_design$Plant, cytoCoxRA_design$Hist, sep = "_")
pcoa_cytoCox2.points <- data.frame(pcoa_cytoCox2$points, group = pcoa_cytoCox2.groups)

# Calculate Centroids (mean and SE)
pcoa_cytoCox2.L.centroids <- reshape2::melt(pcoa_cytoCox2.points, id="group", measure.vars = c("X1", "X2"))
pcoa_cytoCox2.centroids <- acast(pcoa_cytoCox2.L.centroids, variable ~ group, mean)
pcoa_cytoCox2.centroids.se <- acast(pcoa_cytoCox2.L.centroids, variable ~ group, se)
pcoa_cytoCox2.centroids.sd <- acast(pcoa_cytoCox2.L.centroids, variable ~ group, sd)

# Combine
pcoa_cytoCox2.cent.dataframe <- cbind(t(pcoa_cytoCox2.centroids), t(pcoa_cytoCox2.centroids.se))
colnames(pcoa_cytoCox2.cent.dataframe) <- c("V1", "V2", "V1e", "V2e")

trt <- c("baseline", "baseline", "dry","dry", "dry","dry","wet","wet", "wet","wet") 
plant <- c("baseline", "baseline", "no plant","no plant","plant", "plant", "no plant","no plant","plant", "plant")
history <- c("D", "W", "D", "W", "D", "W", "D", "W", "D", "W")

pcoa_cytoCox2.cent.dataframe.trts <- as.data.frame(pcoa_cytoCox2.cent.dataframe) 
pcoa_cytoCox2.cent.dataframe.trts$trt <- as.factor(trt) # now you add the new columns that you made above to the pcoa.cent.dataframe.trts df
pcoa_cytoCox2.cent.dataframe.trts$plant <- as.factor(plant)
pcoa_cytoCox2.cent.dataframe.trts$history <- as.factor(history)

#Plot using ggplot2
df4b <- as.data.frame(pcoa_cytoCox2.cent.dataframe.trts)
plot4b <- ggplot(df4b, aes(x=V1, y=V2, colour=trt, shape = plant)) + theme_bw() 
plot4b + theme(panel.grid.major = element_blank(), 
               panel.grid.minor = element_blank(), 
               axis.line = element_line(colour = "black")) + 
  theme(panel.background = element_blank()) + 
  geom_errorbarh(aes(xmax=V1+V1e, xmin=V1-V1e), colour="black") + 
  geom_errorbar(aes(ymax=V2+V2e, ymin=V2-V2e), colour="black") +
  geom_point(aes(colour=trt, shape=plant), size=5, stroke = 1.25, show.legend = TRUE) +
  geom_text(aes(label=history, hjust=-1.2, vjust=1, fontface="bold"), size=3.5, show.legend = FALSE) +
  scale_colour_manual(labels = c("baseline","dry","wet"), 
                      values = c("gray70", "cyan", "darkblue")) +
  scale_shape_manual(labels = c("baseline","no plant","plant"), values = c(16,22,15)) +
  theme(axis.title = element_text(size=14), 
        axis.text = element_text(size=14),
        axis.text.x = element_text(size=14), 
        panel.border = element_rect(colour = "black", size = 1.25)) + 
  theme(axis.ticks.length = unit(0.3, "cm")) + 
        xlab("PCoA 1 (50.7%)") + ylab("PCoA 2 (35.6%)") +
        labs(colour = "Hydrologic Treatment", shape = "Plant") +
    guides(colour = guide_legend(override.aes = list(pch=16, size = 4)),
           shape = guide_legend(override.aes = list(size = 4)))+
    ggtitle("Cytochrome C Oxidase Community Composition")
#ggsave("../figures/CcOcomposition4b.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
```
Principal Coordinates Analysis (PCoA) cytochrome C oxidase, attempting to add History:
  Maintain: pcoa_cytoCox2.groups <- paste(cytoCoxRA_design$Treat, cytoCoxRA_design$Plant, cytoCoxRA_design$Hist, sep = "_")
  but recode a "Hydrology" column in the data frame to be plotted that combines hydrologic history and treatment. So, 8 values, ranging from DryHistory_DryTreatment to WetHistory_WetTreatment, and shade the colors to deeper blue with increasing wetness.
```{r}
# Classical (Metric) Multidimensional Scaling; returns PCoA coordinates
# eig=TRUE returns eigenvalues; k = # of dimensions to calculate
pcoa_cytoCox3 <- cmdscale(cytoCoxBC, k=3, eig=TRUE, add=FALSE)

explainvar1b_cytoCox3 <- round(pcoa_cytoCox3$eig[1] / sum(pcoa_cytoCox3$eig), 3) * 100
explainvar2b_cytoCox3 <- round(pcoa_cytoCox3$eig[2] / sum(pcoa_cytoCox3$eig), 3) * 100
sum.eigb <- sum(explainvar1b_cytoCox3, explainvar2b_cytoCox3)

explainvar1b_cytoCox3 # 50.7
explainvar2b_cytoCox3 # 35.6

pcoa_cytoCox3.groups <- paste(cytoCoxRA_design$Treat, cytoCoxRA_design$Plant, cytoCoxRA_design$Hist, sep = "_")
pcoa_cytoCox3.points <- data.frame(pcoa_cytoCox3$points, group = pcoa_cytoCox3.groups)

# Calculate Centroids (mean and SE)
pcoa_cytoCox3.L.centroids <- reshape2::melt(pcoa_cytoCox3.points, id="group", measure.vars = c("X1", "X2"))
pcoa_cytoCox3.centroids <- acast(pcoa_cytoCox3.L.centroids, variable ~ group, mean)
pcoa_cytoCox3.centroids.se <- acast(pcoa_cytoCox3.L.centroids, variable ~ group, se)
pcoa_cytoCox3.centroids.sd <- acast(pcoa_cytoCox3.L.centroids, variable ~ group, sd)

# Combine
pcoa_cytoCox3.cent.dataframe <- cbind(t(pcoa_cytoCox3.centroids), t(pcoa_cytoCox3.centroids.se))
colnames(pcoa_cytoCox3.cent.dataframe) <- c("V1", "V2", "V1e", "V2e")

trt <- c("baseline", "baseline", "dry","dry", "dry","dry","wet","wet", "wet","wet") 
plant <- c("baseline", "baseline", "no plant","no plant","plant", "plant", "no plant","no plant","plant", "plant")
history <- c("D", "W", "D", "W", "D", "W", "D", "W", "D", "W")
hydro_combined <- c(paste(trt, history, sep = "_"))

pcoa_cytoCox3.cent.dataframe.trts <- as.data.frame(pcoa_cytoCox3.cent.dataframe) 
pcoa_cytoCox3.cent.dataframe.trts$trt <- as.factor(trt) # now you add the new columns that you made above to the pcoa.cent.dataframe.trts df
pcoa_cytoCox3.cent.dataframe.trts$plant <- as.factor(plant)
pcoa_cytoCox3.cent.dataframe.trts$history <- as.factor(history)
pcoa_cytoCox3.cent.dataframe.trts$hydro_combined <- as.factor(hydro_combined)

#Plot using ggplot2
df4c <- as.data.frame(pcoa_cytoCox3.cent.dataframe.trts)
plot4c <- ggplot(df4c, aes(x=V1, y=V2, colour=hydro_combined, shape = plant)) + theme_bw() 
plot4c + theme(panel.grid.major = element_blank(), 
               panel.grid.minor = element_blank(), 
               axis.line = element_line(colour = "black")) + 
  theme(panel.background = element_blank()) + 
  geom_errorbarh(aes(xmax=V1+V1e, xmin=V1-V1e), colour="black") + 
  geom_errorbar(aes(ymax=V2+V2e, ymin=V2-V2e), colour="black") +
  geom_point(aes(colour=hydro_combined, shape=plant), size=5, stroke = 1.25, show.legend = TRUE) +
  scale_colour_manual(labels = c("baseline_D", "baseline_W", "dry_D", "dry_W", "wet_D", "wet_W"), 
                      values = c("gray70", "grey28", "paleturquoise", "deepskyblue", "blue", "midnightblue")) +
  scale_shape_manual(labels = c("baseline","no plant","plant"), values = c(16,22,15)) +
  theme(axis.title = element_text(size=14), 
        axis.text = element_text(size=14),
        axis.text.x = element_text(size=14), 
        panel.border = element_rect(colour = "black", size = 1.25)) + 
  theme(axis.ticks.length = unit(0.3, "cm")) + 
        xlab("PCoA 1 (50.7%)") + ylab("PCoA 2 (35.6%)") +
        labs(colour = "Hydrology (treatment_history)", shape = "Plant") +
    guides(colour = guide_legend(override.aes = list(pch=16, size = 4)),
           shape = guide_legend(override.aes = list(size = 4)))+
    ggtitle("Cytochrome C Oxidase Community Composition")
ggsave("../figures/CcOcomposition4c.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
```
Now trying to add envit() of start and final [CO2] to plot4c:
```{r}
# Classical (Metric) Multidimensional Scaling; returns PCoA coordinates
# eig=TRUE returns eigenvalues; k = # of dimensions to calculate
pcoa_cytoCox3 <- cmdscale(cytoCoxBC, k=3, eig=TRUE, add=FALSE)

explainvar1b_cytoCox3 <- round(pcoa_cytoCox3$eig[1] / sum(pcoa_cytoCox3$eig), 3) * 100
explainvar2b_cytoCox3 <- round(pcoa_cytoCox3$eig[2] / sum(pcoa_cytoCox3$eig), 3) * 100
sum.eigb <- sum(explainvar1b_cytoCox3, explainvar2b_cytoCox3)

explainvar1b_cytoCox3 # 50.7
explainvar2b_cytoCox3 # 35.6

pcoa_cytoCox3.groups <- paste(cytoCoxRA_design$Treat, cytoCoxRA_design$Plant, cytoCoxRA_design$Hist, sep = "_")
pcoa_cytoCox3.points <- data.frame(pcoa_cytoCox3$points, group = pcoa_cytoCox3.groups)

# Calculate Centroids (mean and SE)
pcoa_cytoCox3.L.centroids <- reshape2::melt(pcoa_cytoCox3.points, id="group", measure.vars = c("X1", "X2"))
pcoa_cytoCox3.centroids <- acast(pcoa_cytoCox3.L.centroids, variable ~ group, mean)
pcoa_cytoCox3.centroids.se <- acast(pcoa_cytoCox3.L.centroids, variable ~ group, se)
pcoa_cytoCox3.centroids.sd <- acast(pcoa_cytoCox3.L.centroids, variable ~ group, sd)

# Combine
pcoa_cytoCox3.cent.dataframe <- cbind(t(pcoa_cytoCox3.centroids), t(pcoa_cytoCox3.centroids.se))
colnames(pcoa_cytoCox3.cent.dataframe) <- c("V1", "V2", "V1e", "V2e")

trt <- c("baseline", "baseline", "dry","dry", "dry","dry","wet","wet", "wet","wet") 
plant <- c("baseline", "baseline", "no plant","no plant","plant", "plant", "no plant","no plant","plant", "plant")
history <- c("D", "W", "D", "W", "D", "W", "D", "W", "D", "W")
hydro_combined <- c(paste(trt, history, sep = "_"))

pcoa_cytoCox3.cent.dataframe.trts <- as.data.frame(pcoa_cytoCox3.cent.dataframe) 
pcoa_cytoCox3.cent.dataframe.trts$trt <- as.factor(trt) # now you add the new columns that you made above to the pcoa.cent.dataframe.trts df
pcoa_cytoCox3.cent.dataframe.trts$plant <- as.factor(plant)
pcoa_cytoCox3.cent.dataframe.trts$history <- as.factor(history)
pcoa_cytoCox3.cent.dataframe.trts$hydro_combined <- as.factor(hydro_combined)

#Run envfit to see which [GHG]s (start or finish) are explained by ordination:
fit_cytoCox3 <- envfit(pcoa_cytoCox3$points, GHG_metaG$mg.CO2.N.m.2, permutations = 1000)
#fit_cytoCox3 <- envfit(pcoa_cytoCox3$points, GHG_metaG, permutations = 1000) #None of the other GHGs are significant either, so no point in adding them here.
fit_cytoCox3

A <-as.list(fit_cytoCox3$vectors)
vec<-as.data.frame(fit_cytoCox3$vectors$arrows*sqrt(fit_cytoCox3$vectors$r)*0.35) #What is this calculation?
p<- as.data.frame(A$pvals)
vec <- cbind(vec, p)
#vec <-  subset(vec, A$pvals<=0.05) #Should I only add the vec if the pval is <= 0.05?

#Plot using ggplot2
df4d <- as.data.frame(pcoa_cytoCox3.cent.dataframe.trts)
plot4d <- ggplot(df4d, aes(x=V1, y=V2, colour=hydro_combined, shape = plant)) + theme_bw() 
plot4d + theme(panel.grid.major = element_blank(), 
               panel.grid.minor = element_blank(), 
               axis.line = element_line(colour = "black")) + 
  theme(panel.background = element_blank()) + 
  geom_errorbarh(aes(xmax=V1+V1e, xmin=V1-V1e), colour="black") + 
  geom_errorbar(aes(ymax=V2+V2e, ymin=V2-V2e), colour="black") +
  geom_point(aes(colour=hydro_combined, shape=plant), size=5, stroke = 1.25, show.legend = TRUE) +
  geom_segment(data=vec, aes(x=0,xend=Dim1,y=0,yend=Dim2), size=1, 
      arrow = arrow(length = unit(0.2, "cm")),colour="black",inherit.aes=F)+
  geom_text(data=vec,aes(x=-0.013,y=-0.065,label="mg.CO2.N.m.2"),size=5, inherit.aes=F)+
  scale_colour_manual(labels = c("baseline_D", "baseline_W", "dry_D", "dry_W", "wet_D", "wet_W"), 
                      values = c("gray70", "grey28", "paleturquoise", "deepskyblue", "blue", "midnightblue")) +
  scale_shape_manual(labels = c("baseline","no plant","plant"), values = c(16,22,15)) +
  theme(axis.title = element_text(size=14), 
        axis.text = element_text(size=14),
        axis.text.x = element_text(size=14), 
        panel.border = element_rect(colour = "black", size = 1.25)) + 
  theme(axis.ticks.length = unit(0.3, "cm")) + 
        xlab("PCoA 1 (50.7%)") + ylab("PCoA 2 (35.6%)") +
        labs(colour = "Hydrology (treatment_history)", shape = "Plant") +
    guides(colour = guide_legend(override.aes = list(pch=16, size = 4)),
           shape = guide_legend(override.aes = list(size = 4)))+
    ggtitle("Cytochrome C Oxidase Community Composition")
#ggsave("../figures/CcOcomposition4d.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
```

